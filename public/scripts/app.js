(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";

var _game = require("./game");

var _game2 = _interopRequireDefault(_game);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

document.addEventListener("DOMContentLoaded", function () {
  var game = new _game2.default(4);
});

},{"./game":2}],2:[function(require,module,exports){
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _store = require('./store');

var _store2 = _interopRequireDefault(_store);

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Game = function Game(size) {
  this.size = size;
  this.$table = document.querySelector('.grid-container');
  this.$tileContainer = document.querySelector('.tile-container');
  this.queue = [];
  this.setup();
};

Game.prototype.setup = function () {
  this.store = new _store2.default();
  this.store.subscribe(this.render.bind(this));
  this.store.dispatch({
    type: 'INIT',
    size: 4
  });
  this.eventListeners();
};

Game.prototype.render = function (state) {
  var grid = state.grid;
  var tiles = (0, _utils.flattern)((0, _utils.flattern)(grid));
  for (var i = 0; i < tiles.length; i++) {
    var $tile = document.createElement('div');
    $tile.classList.add('tile');
    $tile.classList.add('tile-' + tiles[i].value);
    $tile.classList.add('tile-position-' + (tiles[i].x + 1) + '-' + (tiles[i].y + 1));
    $tile.innerHTML = tiles[i].value;
    this.$tileContainer.appendChild($tile);
  }
};

Game.prototype.eventListeners = function () {
  var _this = this;

  var map = {
    38: 'UP',
    39: 'RIGHT',
    40: 'DOWN',
    37: 'LEFT',
    75: 'UP',
    76: 'RIGHT',
    74: 'DOWN',
    72: 'LEFT'
  };
  document.addEventListener("keydown", function (event) {
    var modifiers = event.altKey || event.ctrlKey || event.metaKey || event.shiftKey;
    var direction = map[event.which];

    if (!modifiers) {
      if (direction !== undefined) {
        event.preventDefault();
        _this._prepare(direction);
      }
    }
  });
};

Game.prototype._prepare = function (direction) {
  this.store.dispatch({
    type: 'MOVE_TILE',
    direction: direction
  });
};

exports.default = Game;

},{"./store":3,"./utils":4}],3:[function(require,module,exports){
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _utils = require('./utils');

var subscribers = [];
var id = 0;
var initialState = {
  win: null,
  score: 0,
  cells: (0, _utils.generateCells)(4, 4),
  grid: (0, _utils.generateGrid)(4, 4),
  isActual: true
};

var Store = function Store() {
  this.oldState = {};
  this.state = initialState;
};

Store.prototype.subscribe = function (cb) {
  subscribers.push(cb);
};

Store.prototype.triggerSubscribers = function () {
  var _this = this;

  subscribers.forEach(function (subscriber) {
    subscriber(_this.state);
  });
};

Store.prototype.reduce = function (action, state) {
  switch (action.type) {
    case 'INIT':
      return this.getInitialState(action.size);
    case 'MOVE_TILE':
      return moveInDirection(action.direction, state);
  }
  return state;
};

Store.prototype.dispatch = function (action) {
  this.oldState = this.state;
  this.state = this.reduce(action, this.state);
  this.triggerSubscribers();
};

Store.prototype.getState = function () {
  return this.state;
};

Store.prototype.getInitialState = function (size) {
  var startCount = 2;
  var state = this.state;
  var cell = void 0;
  while (startCount > 0) {
    cell = (0, _utils.randomCell)(state.cells);
    console.log(cell);
    state = newTile(state, cell);
    startCount--;
  }
  return state;
};

function newTile(state, cell) {
  state = Object.assign({}, state);
  if (!state.cells.length) return state;

  var x = (0, _utils.flattern)((0, _utils.flattern)(state.grid)).find(function (t) {
    return t.value === 'x';
  });

  if (id > 1 && !x) state = addTile(state, cell, "x");else state = addTile(state, cell);
  state.cells = state.cells.filter(function (obj) {
    return !(obj.x === cell.x && obj.y === cell.y);
  });
  return state;
}

function addTile(state, tile, value) {
  state = Object.assign({}, state);
  tile = Object.assign({}, tile);
  tile.id = id++;
  tile.value = value || 2;
  state.grid[tile.x][tile.y].push(tile);
  return state;
}

function moveInDirection(direction, state) {
  state = Object.assign({}, state);
  var tiles = (0, _utils.flattern)((0, _utils.flattern)(state.grid));
  tiles = sortTiles(tiles, direction);
  state = moveTiles(state, tiles, direction);
  return state;
}

function sortTiles(tiles, direction) {
  var _getCurrent = (0, _utils.getCurrent)(direction);

  var axis = _getCurrent.axis;
  var value = _getCurrent.value;

  tiles = tiles.sort(function (a, b) {
    return a[axis] - b[axis];
  });
  if (value < 0) tiles = tiles.reverse();
  return tiles;
}

function moveTiles(state, tiles, direction) {
  tiles.forEach(function (tile) {
    return state = moveTile(state, tile, direction);
  });
  return state;
}

function moveTile(state, tile, direction) {
  state = Object.assign({}, state);
  var available = findAvailableCell(state, tile, direction);
  if (available) {
    state.isActual = false;
    state.grid[available.index][available.value].push(tile);
    state.grid[tile.x][tile.y].pop();
  }

  return state;
}

function findAvailableCell(state, tile, direction) {
  var available = void 0;

  var _getCurrent2 = (0, _utils.getCurrent)(direction);

  var axis = _getCurrent2.axis;
  var value = _getCurrent2.value;

  var from = tile[axis];
  var to = value < 0 ? 4 - 1 : 0;
  var arr = [];

  while (from <= to) {
    arr.push(from++);
  }

  arr.forEach(function (index) {
    var path = void 0;
    if (axis === 'x') {
      path = {
        index: index,
        value: tile.y
      };
    } else {
      path = {
        index: tile.x,
        value: index
      };
    }

    var cell = state.grid[path.index][path.value];

    if (!isSuitable(cell, tile)) {
      available = null;
      return;
    }

    if (tile.value === "x") {
      if (cell.length === 1 || !cell.length && !available) available = path;
    } else {
      available = available || path;
    }
  });

  return available;
}

function isSuitable(cell, tile) {
  var t1 = cell[0] ? cell[0].value : '';
  var t2 = tile.value;

  if (cell.length > 1) return false;
  if (cell.length) {
    if (t1 === 'x' || t2 === 'x') return true;
    if (t1 !== t2) return false;
  }

  return true;
}

exports.default = Store;

},{"./utils":4}],4:[function(require,module,exports){
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.generateCells = generateCells;
exports.generateGrid = generateGrid;
exports.randomCell = randomCell;
exports.flattern = flattern;
exports.getCurrent = getCurrent;
function generateCells(x, y) {
  var cells = [];

  for (var i = 0; i < x; i++) {
    for (var j = 0; j < y; j++) {
      cells.push({
        x: i,
        y: j
      });
    }
  }

  return cells;
}

function generateGrid(x, y) {
  var cells = [];

  for (var i = 0; i < x; i++) {
    cells[i] = [];
    for (var j = 0; j < y; j++) {
      cells[i][j] = [];
    }
  }

  return cells;
}

function randomCell(cells) {
  var max = cells.length;
  return cells[Math.floor(Math.random() * max)];
}

function flattern(arr) {
  arr = arr.slice();
  return arr.reduce(function (a, b) {
    return a.concat(b);
  });
}

function getCurrent(direction) {
  var axis = void 0;
  var axises = getVector(direction);

  for (var current in axises) {
    if ({}.hasOwnProperty.call(axises, current)) {
      if (axises[current] !== 0) {
        axis = current;
      }
    }
  }

  return {
    axis: axis,
    value: axises[axis]
  };
}

function getVector(direction) {
  var VECTORS = {};
  VECTORS.UP = { x: 1, y: 0 };
  VECTORS.LEFT = { x: 0, y: 1 };
  VECTORS.DOWN = { x: -1, y: 0 };
  VECTORS.RIGHT = { x: 0, y: -1 };
  return VECTORS[direction];
}

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvc2NyaXB0cy9hcHAuanMiLCJzcmMvc2NyaXB0cy9nYW1lLmpzIiwic3JjL3NjcmlwdHMvc3RvcmUuanMiLCJzcmMvc2NyaXB0cy91dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0FDQUE7Ozs7OztBQUVBLFNBQVMsZ0JBQVQsQ0FBMEIsa0JBQTFCLEVBQThDLFlBQVk7QUFDeEQsTUFBTSxPQUFPLG1CQUFTLENBQVQsQ0FBYjtBQUNELENBRkQ7Ozs7Ozs7OztBQ0ZBOzs7O0FBQ0E7Ozs7QUFFQSxJQUFNLE9BQU8sU0FBUyxJQUFULENBQWMsSUFBZCxFQUFvQjtBQUMvQixPQUFLLElBQUwsR0FBWSxJQUFaO0FBQ0EsT0FBSyxNQUFMLEdBQWMsU0FBUyxhQUFULENBQXVCLGlCQUF2QixDQUFkO0FBQ0EsT0FBSyxjQUFMLEdBQXNCLFNBQVMsYUFBVCxDQUF1QixpQkFBdkIsQ0FBdEI7QUFDQSxPQUFLLEtBQUwsR0FBYSxFQUFiO0FBQ0EsT0FBSyxLQUFMO0FBQ0QsQ0FORDs7QUFRQSxLQUFLLFNBQUwsQ0FBZSxLQUFmLEdBQXVCLFlBQVc7QUFDaEMsT0FBSyxLQUFMLEdBQWEscUJBQWI7QUFDQSxPQUFLLEtBQUwsQ0FBVyxTQUFYLENBQXFCLEtBQUssTUFBTCxDQUFZLElBQVosQ0FBaUIsSUFBakIsQ0FBckI7QUFDQSxPQUFLLEtBQUwsQ0FBVyxRQUFYLENBQW9CO0FBQ2xCLFVBQU0sTUFEWTtBQUVsQixVQUFNO0FBRlksR0FBcEI7QUFJQSxPQUFLLGNBQUw7QUFDRCxDQVJEOztBQVVBLEtBQUssU0FBTCxDQUFlLE1BQWYsR0FBd0IsVUFBUyxLQUFULEVBQWdCO0FBQ3RDLE1BQU0sT0FBTyxNQUFNLElBQW5CO0FBQ0EsTUFBTSxRQUFRLHFCQUFTLHFCQUFTLElBQVQsQ0FBVCxDQUFkO0FBQ0EsT0FBSyxJQUFJLElBQUUsQ0FBWCxFQUFjLElBQUksTUFBTSxN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LFVBQVQsQ0FBb0IsU0FBcEIsRUFBK0I7QUFDcEMsTUFBSSxhQUFKO0FBQ0EsTUFBTSxTQUFTLFVBQVUsU0FBVixDQUFmOztBQUVBLE9BQUssSUFBTSxPQUFYLElBQXNCLE1BQXRCLEVBQThCO0FBQzVCLFFBQUksR0FBRyxjQUFILENBQWtCLElBQWxCLENBQXVCLE1BQXZCLEVBQStCLE9BQS9CLENBQUosRUFBNkM7QUFDM0MsVUFBSSxPQUFPLE9BQVAsTUFBb0IsQ0FBeEIsRUFBMkI7QUFDekIsZUFBTyxPQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFNBQU87QUFDTCxjQURLO0FBRUwsV0FBTyxPQUFPLElBQVA7QUFGRixHQUFQO0FBSUQ7O0FBRUQsU0FBUyxTQUFULENBQW1CLFNBQW5CLEVBQThCO0FBQzVCLE1BQU0sVUFBVSxFQUFoQjtBQUNBLFVBQVEsRUFBUixHQUFhLEVBQUMsR0FBRyxDQUFKLEVBQU8sR0FBRyxDQUFWLEVBQWI7QUFDQSxVQUFRLElBQVIsR0FBZSxFQUFDLEdBQUcsQ0FBSixFQUFPLEdBQUcsQ0FBVixFQUFmO0FBQ0EsVUFBUSxJQUFSLEdBQWUsRUFBQyxHQUFHLENBQUMsQ0FBTCxFQUFRLEdBQUcsQ0FBWCxFQUFmO0FBQ0EsVUFBUSxLQUFSLEdBQWdCLEVBQUMsR0FBRyxDQUFKLEVBQU8sR0FBRyxDQUFDLENBQVgsRUFBaEI7QUFDQSxTQUFPLFFBQVEsU0FBUixDQUFQO0FBQ0QiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiaW1wb3J0IEdhbWUgZnJvbSAnLi9nYW1lJztcblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgZnVuY3Rpb24gKCkge1xuICBjb25zdCBnYW1lID0gbmV3IEdhbWUoNCk7XG59KTtcbiIsImltcG9ydCBTdG9yZSBmcm9tICcuL3N0b3JlJztcbmltcG9ydCB7IGZsYXR0ZXJuIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IEdhbWUgPSBmdW5jdGlvbiBHYW1lKHNpemUpIHtcbiAgdGhpcy5zaXplID0gc2l6ZTtcbiAgdGhpcy4kdGFibGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZ3JpZC1jb250YWluZXInKTtcbiAgdGhpcy4kdGlsZUNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50aWxlLWNvbnRhaW5lcicpO1xuICB0aGlzLnF1ZXVlID0gW107XG4gIHRoaXMuc2V0dXAoKTtcbn07XG5cbkdhbWUucHJvdG90eXBlLnNldHVwID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuc3RvcmUgPSBuZXcgU3RvcmUoKTtcbiAgdGhpcy5zdG9yZS5zdWJzY3JpYmUodGhpcy5yZW5kZXIuYmluZCh0aGlzKSk7XG4gIHRoaXMuc3RvcmUuZGlzcGF0Y2goe1xuICAgIHR5cGU6ICdJTklUJyxcbiAgICBzaXplOiA0XG4gIH0pO1xuICB0aGlzLmV2ZW50TGlzdGVuZXJzKCk7XG59O1xuXG5HYW1lLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGF0ZSkge1xuICBjb25zdCBncmlkID0gc3RhdGUuZ3JpZDtcbiAgY29uc3QgdGlsZXMgPSBmbGF0dGVybihmbGF0dGVybihncmlkKSk7XG4gIGZvciAobGV0IGk9MDsgaSA8IHRpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0ICR0aWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgJHRpbGUuY2xhc3NMaXN0LmFkZCgndGlsZScpO1xuICAgICR0aWxlLmNsYXNzTGlzdC5hZGQoYHRpbGUtJHt0aWxlc1tpXS52YWx1ZX1gKTtcbiAgICAkdGlsZS5jbGFzc0xpc3QuYWRkKGB0aWxlLXBvc2l0aW9uLSR7dGlsZXNbaV0ueCArIDF9LSR7dGlsZXNbaV0ueSArIDF9YCk7XG4gICAgJHRpbGUuaW5uZXJIVE1MID0gdGlsZXNbaV0udmFsdWU7XG4gICAgdGhpcy4kdGlsZUNvbnRhaW5lci5hcHBlbmRDaGlsZCgkdGlsZSk7XG4gIH1cbn07XG5cbkdhbWUucHJvdG90eXBlLmV2ZW50TGlzdGVuZXJzID0gZnVuY3Rpb24gKCkge1xuICB2YXIgbWFwID0ge1xuICAgIDM4OiAnVVAnLFxuICAgIDM5OiAnUklHSFQnLFxuICAgIDQwOiAnRE9XTicsXG4gICAgMzc6ICdMRUZUJyxcbiAgICA3NTogJ1VQJyxcbiAgICA3NjonUklHSFQnLFxuICAgIDc0OiAnRE9XTicsXG4gICAgNzI6ICdMRUZUJ1xuICB9O1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCAoZXZlbnQpID0+IHtcbiAgICB2YXIgbW9kaWZpZXJzID0gZXZlbnQuYWx0S2V5IHx8IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fFxuICAgICAgICAgICAgICAgICAgICBldmVudC5zaGlmdEtleTtcbiAgICB2YXIgZGlyZWN0aW9uICAgID0gbWFwW2V2ZW50LndoaWNoXTtcblxuICAgIGlmICghbW9kaWZpZXJzKSB7XG4gICAgICBpZiAoZGlyZWN0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5fcHJlcGFyZShkaXJlY3Rpb24pO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59O1xuXG5HYW1lLnByb3RvdHlwZS5fcHJlcGFyZSA9IGZ1bmN0aW9uKGRpcmVjdGlvbikge1xuICB0aGlzLnN0b3JlLmRpc3BhdGNoKHtcbiAgICB0eXBlOiAnTU9WRV9USUxFJyxcbiAgICBkaXJlY3Rpb25cbiAgfSlcbn07XG5cblxuXG5leHBvcnQgZGVmYXVsdCBHYW1lO1xuIiwiaW1wb3J0IHsgZ2VuZXJhdGVDZWxscywgZ2VuZXJhdGVHcmlkLCByYW5kb21DZWxsLCBmbGF0dGVybiwgZ2V0Q3VycmVudCB9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBzdWJzY3JpYmVycyA9IFtdO1xubGV0IGlkID0gMDtcbmNvbnN0IGluaXRpYWxTdGF0ZSA9IHtcbiAgd2luOiBudWxsLFxuICBzY29yZTogMCxcbiAgY2VsbHM6IGdlbmVyYXRlQ2VsbHMoNCwgNCksXG4gIGdyaWQ6IGdlbmVyYXRlR3JpZCg0LCA0KSxcbiAgaXNBY3R1YWw6IHRydWVcbn07XG5cbmNvbnN0IFN0b3JlID0gZnVuY3Rpb24gU3RvcmUoKSB7XG4gIHRoaXMub2xkU3RhdGUgPSB7fTtcbiAgdGhpcy5zdGF0ZSA9IGluaXRpYWxTdGF0ZTtcbn07XG5cblN0b3JlLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbihjYikge1xuICBzdWJzY3JpYmVycy5wdXNoKGNiKTtcbn07XG5cblN0b3JlLnByb3RvdHlwZS50cmlnZ2VyU3Vic2NyaWJlcnMgPSBmdW5jdGlvbigpIHtcbiAgc3Vic2NyaWJlcnMuZm9yRWFjaCgoc3Vic2NyaWJlcikgPT4ge1xuICAgIHN1YnNjcmliZXIodGhpcy5zdGF0ZSk7XG4gIH0pO1xufTtcblxuU3RvcmUucHJvdG90eXBlLnJlZHVjZSA9IGZ1bmN0aW9uKGFjdGlvbiwgc3RhdGUpIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ0lOSVQnOlxuICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5pdGlhbFN0YXRlKGFjdGlvbi5zaXplKTtcbiAgICBjYXNlICdNT1ZFX1RJTEUnOlxuICAgICAgcmV0dXJuIG1vdmVJbkRpcmVjdGlvbihhY3Rpb24uZGlyZWN0aW9uLCBzdGF0ZSk7XG4gIH1cbiAgcmV0dXJuIHN0YXRlO1xufTtcblxuU3RvcmUucHJvdG90eXBlLmRpc3BhdGNoID0gZnVuY3Rpb24oYWN0aW9uKSB7XG4gIHRoaXMub2xkU3RhdGUgPSB0aGlzLnN0YXRlO1xuICB0aGlzLnN0YXRlID0gdGhpcy5yZWR1Y2UoYWN0aW9uLCB0aGlzLnN0YXRlKTtcbiAgdGhpcy50cmlnZ2VyU3Vic2NyaWJlcnMoKTtcbn07XG5cblN0b3JlLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gdGhpcy5zdGF0ZTtcbn07XG5cblN0b3JlLnByb3RvdHlwZS5nZXRJbml0aWFsU3RhdGUgPSBmdW5jdGlvbihzaXplKSB7XG4gIGxldCBzdGFydENvdW50ID0gMjtcbiAgbGV0IHN0YXRlID0gdGhpcy5zdGF0ZTtcbiAgbGV0IGNlbGw7XG4gIHdoaWxlIChzdGFydENvdW50ID4gMCkge1xuICAgIGNlbGwgPSByYW5kb21DZWxsKHN0YXRlLmNlbGxzKTtcbiAgICBjb25zb2xlLmxvZyhjZWxsKTtcbiAgICBzdGF0ZSA9IG5ld1RpbGUoc3RhdGUsIGNlbGwpO1xuICAgIHN0YXJ0Q291bnQtLTtcbiAgfVxuICByZXR1cm4gc3RhdGU7XG59O1xuXG5mdW5jdGlvbiBuZXdUaWxlKHN0YXRlLCBjZWxsKSB7XG4gIHN0YXRlID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUpO1xuICBpZiAoIXN0YXRlLmNlbGxzLmxlbmd0aCkgcmV0dXJuIHN0YXRlO1xuXG4gIGNvbnN0IHggPSBmbGF0dGVybihmbGF0dGVybihzdGF0ZS5ncmlkKSkuZmluZCgodCkgPT4ge1xuICAgIHJldHVybiB0LnZhbHVlID09PSAneCc7XG4gIH0pO1xuXG4gIGlmIChpZCA+IDEgJiYgIXgpIHN0YXRlID0gYWRkVGlsZShzdGF0ZSwgY2VsbCwgXCJ4XCIpO1xuICBlbHNlIHN0YXRlID0gYWRkVGlsZShzdGF0ZSwgY2VsbCk7XG4gIHN0YXRlLmNlbGxzID0gc3RhdGUuY2VsbHMuZmlsdGVyKChvYmopID0+IHtcbiAgICByZXR1cm4gIShvYmoueCA9PT0gY2VsbC54ICYmIG9iai55ID09PSBjZWxsLnkpO1xuICB9KTtcbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBhZGRUaWxlKHN0YXRlLCB0aWxlLCB2YWx1ZSkge1xuICBzdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXRlKTtcbiAgdGlsZSA9IE9iamVjdC5hc3NpZ24oe30sIHRpbGUpO1xuICB0aWxlLmlkID0gaWQrKztcbiAgdGlsZS52YWx1ZSA9IHZhbHVlIHx8IDI7XG4gIHN0YXRlLmdyaWRbdGlsZS54XVt0aWxlLnldLnB1c2godGlsZSk7XG4gIHJldHVybiBzdGF0ZTtcbn1cblxuZnVuY3Rpb24gbW92ZUluRGlyZWN0aW9uKGRpcmVjdGlvbiwgc3RhdGUpIHtcbiAgc3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSk7XG4gIGxldCB0aWxlcyA9IGZsYXR0ZXJuKGZsYXR0ZXJuKHN0YXRlLmdyaWQpKTtcbiAgdGlsZXMgPSBzb3J0VGlsZXModGlsZXMsIGRpcmVjdGlvbik7XG4gIHN0YXRlID0gbW92ZVRpbGVzKHN0YXRlLCB0aWxlcywgZGlyZWN0aW9uKTtcbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBzb3J0VGlsZXModGlsZXMsIGRpcmVjdGlvbikge1xuICBjb25zdCB7YXhpcywgdmFsdWV9ID0gZ2V0Q3VycmVudChkaXJlY3Rpb24pO1xuICB0aWxlcyA9IHRpbGVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICByZXR1cm4gYVtheGlzXSAtIGJbYXhpc107XG4gIH0pO1xuICBpZiAodmFsdWUgPCAwKSB0aWxlcyA9IHRpbGVzLnJldmVyc2UoKTtcbiAgcmV0dXJuIHRpbGVzO1xufVxuXG5mdW5jdGlvbiBtb3ZlVGlsZXMoc3RhdGUsIHRpbGVzLCBkaXJlY3Rpb24pIHtcbiAgdGlsZXMuZm9yRWFjaCh0aWxlID0+IHN0YXRlID0gbW92ZVRpbGUoc3RhdGUsIHRpbGUsIGRpcmVjdGlvbikpO1xuICByZXR1cm4gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIG1vdmVUaWxlKHN0YXRlLCB0aWxlLCBkaXJlY3Rpb24pIHtcbiAgc3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSk7XG4gIGNvbnN0IGF2YWlsYWJsZSA9IGZpbmRBdmFpbGFibGVDZWxsKHN0YXRlLCB0aWxlLCBkaXJlY3Rpb24pO1xuICBpZiAoYXZhaWxhYmxlKSB7XG4gICAgc3RhdGUuaXNBY3R1YWwgPSBmYWxzZTtcbiAgICBzdGF0ZS5ncmlkW2F2YWlsYWJsZS5pbmRleF1bYXZhaWxhYmxlLnZhbHVlXS5wdXNoKHRpbGUpO1xuICAgIHN0YXRlLmdyaWRbdGlsZS54XVt0aWxlLnldLnBvcCgpO1xuICB9XG5cbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBmaW5kQXZhaWxhYmxlQ2VsbChzdGF0ZSwgdGlsZSwgZGlyZWN0aW9uKSB7XG4gIGxldCBhdmFpbGFibGU7XG4gIGNvbnN0IHtheGlzLCB2YWx1ZX0gPSBnZXRDdXJyZW50KGRpcmVjdGlvbik7XG4gIGxldCBmcm9tID0gdGlsZVtheGlzXTtcbiAgY29uc3QgdG8gPSB2YWx1ZSA8IDAgPyAoNCAtIDEpIDogMDtcbiAgY29uc3QgYXJyID0gW107XG5cbiAgd2hpbGUoZnJvbSA8PSB0bykge1xuICAgIGFyci5wdXNoKGZyb20rKyk7XG4gIH1cblxuICBhcnIuZm9yRWFjaChpbmRleCA9PiB7XG4gICAgbGV0IHBhdGg7XG4gICAgaWYgKGF4aXMgPT09ICd4Jykge1xuICAgICAgcGF0aCA9IHtcbiAgICAgICAgaW5kZXg6IGluZGV4LFxuICAgICAgICB2YWx1ZTogdGlsZS55XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXRoID0ge1xuICAgICAgICBpbmRleDogdGlsZS54LFxuICAgICAgICB2YWx1ZTogaW5kZXhcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgY2VsbCA9IHN0YXRlLmdyaWRbcGF0aC5pbmRleF1bcGF0aC52YWx1ZV07XG5cbiAgICBpZiAoIWlzU3VpdGFibGUoY2VsbCwgdGlsZSkpIHtcbiAgICAgIGF2YWlsYWJsZSA9IG51bGw7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRpbGUudmFsdWUgPT09IFwieFwiKSB7XG4gICAgICBpZiAoY2VsbC5sZW5ndGggPT09IDEgfHwgKCFjZWxsLmxlbmd0aCAmJiAhYXZhaWxhYmxlKSkgYXZhaWxhYmxlID0gcGF0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgYXZhaWxhYmxlID0gYXZhaWxhYmxlIHx8IHBhdGg7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gYXZhaWxhYmxlO1xufVxuXG5mdW5jdGlvbiBpc1N1aXRhYmxlKGNlbGwsIHRpbGUpIHtcbiAgY29uc3QgdDEgPSBjZWxsWzBdID8gY2VsbFswXS52YWx1ZSA6ICcnO1xuICBjb25zdCB0MiA9IHRpbGUudmFsdWU7XG5cbiAgaWYgKGNlbGwubGVuZ3RoID4gMSkgcmV0dXJuIGZhbHNlO1xuICBpZiAoY2VsbC5sZW5ndGgpIHtcbiAgICBpZiAodDEgPT09ICd4JyB8fCB0MiA9PT0gJ3gnKSByZXR1cm4gdHJ1ZTtcbiAgICBpZiAodDEgIT09IHQyKSByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuXG5cbmV4cG9ydCBkZWZhdWx0IFN0b3JlO1xuIiwiZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlQ2VsbHMoeCwgeSkge1xuICBsZXQgY2VsbHMgPSBbXTtcblxuICBmb3IgKGxldCBpPTA7IGk8eDsgaSsrKSB7XG4gICAgZm9yIChsZXQgaj0wOyBqPHk7IGorKykge1xuICAgICAgY2VsbHMucHVzaCh7XG4gICAgICAgIHg6IGksXG4gICAgICAgIHk6IGpcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBjZWxscztcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVHcmlkKHgsIHkpIHtcbiAgbGV0IGNlbGxzID0gW107XG5cbiAgZm9yIChsZXQgaT0wOyBpPHg7IGkrKykge1xuICAgIGNlbGxzW2ldID0gW107XG4gICAgZm9yIChsZXQgaj0wOyBqPHk7IGorKykge1xuICAgICAgY2VsbHNbaV1bal0gPSBbXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gY2VsbHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByYW5kb21DZWxsKGNlbGxzKSB7XG4gIGNvbnN0IG1heCA9IGNlbGxzLmxlbmd0aDtcbiAgcmV0dXJuIGNlbGxzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG1heCldO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlcm4oYXJyKSB7XG4gIGFyciA9IGFyci5zbGljZSgpO1xuICByZXR1cm4gYXJyLnJlZHVjZSgoYSwgYikgPT4ge1xuICAgIHJldHVybiBhLmNvbmNhdChiKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDdXJyZW50KGRpcmVjdGlvbikge1xuICBsZXQgYXhpcztcbiAgY29uc3QgYXhpc2VzID0gZ2V0VmVjdG9yKGRpcmVjdGlvbik7XG5cbiAgZm9yIChjb25zdCBjdXJyZW50IGluIGF4aXNlcykge1xuICAgIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGF4aXNlcywgY3VycmVudCkpIHtcbiAgICAgIGlmIChheGlzZXNbY3VycmVudF0gIT09IDApIHtcbiAgICAgICAgYXhpcyA9IGN1cnJlbnQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBheGlzLFxuICAgIHZhbHVlOiBheGlzZXNbYXhpc11cbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0VmVjdG9yKGRpcmVjdGlvbikge1xuICBjb25zdCBWRUNUT1JTID0ge307XG4gIFZFQ1RPUlMuVVAgPSB7eDogMSwgeTogMH07XG4gIFZFQ1RPUlMuTEVGVCA9IHt4OiAwLCB5OiAxfTtcbiAgVkVDVE9SUy5ET1dOID0ge3g6IC0xLCB5OiAwfTtcbiAgVkVDVE9SUy5SSUdIVCA9IHt4OiAwLCB5OiAtMX07XG4gIHJldHVybiBWRUNUT1JTW2RpcmVjdGlvbl07XG59XG4iXX0=
