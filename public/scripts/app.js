(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";

var _game = require("./game");

var _game2 = _interopRequireDefault(_game);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

document.addEventListener("DOMContentLoaded", function () {
  var game = new _game2.default(4);
});

},{"./game":2}],2:[function(require,module,exports){
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _store = require('./store');

var _store2 = _interopRequireDefault(_store);

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Game = function Game(size) {
  this.size = size;
  this.$table = document.querySelector('.grid-container');
  this.$tileContainer = document.querySelector('.tile-container');
  this.queue = [];
  this.setup();
};

Game.prototype.setup = function () {
  this.store = new _store2.default();
  this.store.subscribe(this.render.bind(this));
  this.store.dispatch({
    type: 'INIT',
    size: 4
  });
  this.eventListeners();
};

Game.prototype.render = function (state) {
  this.$tileContainer.innerHTML = '';
  var grid = state.grid;
  var tiles = (0, _utils.flattern)((0, _utils.flattern)(grid));
  for (var i = 0; i < tiles.length; i++) {
    var $tile = document.createElement('div');
    $tile.classList.add('tile');
    $tile.classList.add('tile-' + tiles[i].value);
    $tile.classList.add('tile-position-' + (tiles[i].x + 1) + '-' + (tiles[i].y + 1));
    $tile.innerHTML = tiles[i].value;
    this.$tileContainer.appendChild($tile);
  }
};

Game.prototype.eventListeners = function () {
  var _this = this;

  var map = {
    38: 'UP',
    39: 'RIGHT',
    40: 'DOWN',
    37: 'LEFT'
  };
  document.addEventListener("keydown", function (event) {
    var modifiers = event.altKey || event.ctrlKey || event.metaKey || event.shiftKey;
    var direction = map[event.which];

    if (!modifiers) {
      if (direction !== undefined) {
        event.preventDefault();
        _this._prepare(direction);
      }
    }
  });
};

Game.prototype._prepare = function (direction) {
  var _this2 = this;

  this.store.dispatch({
    type: 'MOVE_TILE',
    direction: direction
  });
  setTimeout(function () {
    _this2.store.dispatch({
      type: 'ACTUALIZE'
    });
  }, 1000);

  setTimeout(function () {
    _this2.store.dispatch({
      type: 'MERGE_TILE'
    });
  }, 200);
};

exports.default = Game;

},{"./store":3,"./utils":4}],3:[function(require,module,exports){
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _utils = require('./utils');

var subscribers = [];
var id = 0;
var initialState = {
  win: null,
  score: 0,
  cells: (0, _utils.generateCells)(4, 4),
  grid: (0, _utils.generateGrid)(4, 4),
  isActual: true
};

var Store = function Store() {
  this.oldState = {};
  this.state = initialState;
};

Store.prototype.subscribe = function (cb) {
  subscribers.push(cb);
};

Store.prototype.triggerSubscribers = function () {
  var _this = this;

  subscribers.forEach(function (subscriber) {
    subscriber(_this.state);
  });
};

Store.prototype.reduce = function (action, state) {
  switch (action.type) {
    case 'INIT':
      return this.getInitialState(action.size);
    case 'MOVE_TILE':
      return moveInDirection(action.direction, state);
    case 'ACTUALIZE':
      return actualize(state);
    case 'MERGE_TILE':
      return mergeTiles(state);
  }
  return state;
};

Store.prototype.dispatch = function (action) {
  this.oldState = this.state;
  this.state = this.reduce(action, this.state);
  this.triggerSubscribers();
};

Store.prototype.getState = function () {
  return this.state;
};

Store.prototype.getInitialState = function (size) {
  var startCount = 2;
  var state = this.state;
  var cell = void 0;
  while (startCount > 0) {
    cell = (0, _utils.randomCell)(state.cells);
    console.log(cell);
    state = newTile(state, cell);
    startCount--;
  }
  return state;
};

function newTile(state, cell) {
  state = Object.assign({}, state);
  if (!state.cells.length) return state;

  var x = (0, _utils.flattern)((0, _utils.flattern)(state.grid)).find(function (t) {
    return t.value === 'x';
  });

  if (id > 1 && !x) state = addTile(state, cell, "x");else state = addTile(state, cell);
  state.cells = state.cells.filter(function (obj) {
    return !(obj.x === cell.x && obj.y === cell.y);
  });
  return state;
}

function addTile(state, tile, value) {
  state = Object.assign({}, state);
  tile = Object.assign({}, tile);
  tile.id = id++;
  tile.value = value || 2;
  state.grid[tile.x][tile.y].push(tile);
  return state;
}

function moveInDirection(direction, state) {
  state = Object.assign({}, state);
  var initial = state;
  var directions = ['UP', 'RIGHT', 'DOWN', 'LEFT'];
  var tiles = (0, _utils.flattern)((0, _utils.flattern)(state.grid));

  var check = function check(current) {
    if (current !== direction) initial = state;

    directions = directions.filter(function (dir) {
      return dir !== current;
    });
    tiles = sortTiles(tiles, current);
    state = moveTiles(state, tiles, current);

    if (initial === state) {
      if (directions.length) return check(directions[0]);
      return state.win = false;
    }

    return current !== direction ? initial : state;
  };

  return check(direction);
}

function sortTiles(tiles, direction) {
  var _getCurrent = (0, _utils.getCurrent)(direction);

  var axis = _getCurrent.axis;
  var value = _getCurrent.value;

  tiles = tiles.sort(function (a, b) {
    return a[axis] - b[axis];
  });
  if (value < 0) tiles = tiles.reverse();
  return tiles;
}

function moveTiles(state, tiles, direction) {
  tiles.forEach(function (tile) {
    return state = moveTile(state, tile, direction);
  });
  return state;
}

function moveTile(state, tile, direction) {
  state = Object.assign({}, state);
  var available = findAvailableCell(state, tile, direction);
  if (available) {
    state.isActual = false;
    state.grid[available.index][available.value].push(tile);
    state.grid[tile.x][tile.y].pop();
  }

  return state;
}

function findAvailableCell(state, tile, direction) {
  var available = void 0;

  var _getCurrent2 = (0, _utils.getCurrent)(direction);

  var axis = _getCurrent2.axis;
  var value = _getCurrent2.value;

  var from = tile[axis];
  var to = value < 0 ? 4 - 1 : 0;
  var arr = [];

  if (from <= to) {
    while (from <= to) {
      arr.push(from++);
    }
  } else {
    while (to >= from) {
      arr.push(to--);
    }
  }

  arr.forEach(function (index) {
    var path = void 0;
    if (axis === 'x') {
      path = {
        index: index,
        value: tile.y
      };
    } else {
      path = {
        index: tile.x,
        value: index
      };
    }

    var cell = state.grid[path.index][path.value];

    if (!isSuitable(cell, tile)) {
      available = null;
      return;
    }

    if (tile.value === "x") {
      if (cell.length === 1 || !cell.length && !available) available = path;
    } else {
      available = available || path;
    }
  });

  return available;
}

function isSuitable(cell, tile) {
  var t1 = cell[0] ? cell[0].value : '';
  var t2 = tile.value;

  if (cell.length > 1) return false;
  if (cell.length) {
    if (t1 === 'x' || t2 === 'x') return true;
    if (t1 !== t2) return false;
  }

  return true;
}

function actualize(state) {
  state = Object.assign({}, state);
  var grid = state.grid;

  grid.forEach(function (row, x) {
    row.forEach(function (cell, y) {
      if (!cell.length) return;
      cell.forEach(function (tile, index) {
        if (tile.x !== x || tile.y !== y) {
          grid[x][y][index].x = x;
          grid[x][y][index].y = y;
        }
      });
    });
  });
  state.isActual = true;
  state.grid = grid;
  return state;
}

function mergeTiles(state) {
  state = Object.assign({}, state);
  var cells = [];
  var grid = state.grid;
  var result = 0;

  grid.forEach(function (row, x) {
    row.forEach(function (cell, y) {
      if (!cell.length) {
        cells.push({ x: x, y: y });
      }
      if (cell.length > 1) {
        var value = cell.reduce(function (t1, t2) {
          return calculateTiles(t1, t2);
        });

        result += value;
        // grid = grid.updateIn([x, y], () => List.of(cell.first().merge({value, id: id++})));
        state.win = value === '2048' || null;
        state.score += value;
      }
    });
  });

  state.cells = cells;
  state.result = result;
  state.grid = grid;

  return state;
}

function calculateTiles(t1, t2) {
  if (t1.value === "x") return t2.value * 2;
  if (t2.value === "x") return t1.value * 2;
  return t1.value + t2.value;
}

exports.default = Store;

},{"./utils":4}],4:[function(require,module,exports){
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.generateCells = generateCells;
exports.generateGrid = generateGrid;
exports.randomCell = randomCell;
exports.flattern = flattern;
exports.getCurrent = getCurrent;
function generateCells(x, y) {
  var cells = [];

  for (var i = 0; i < x; i++) {
    for (var j = 0; j < y; j++) {
      cells.push({
        x: i,
        y: j
      });
    }
  }

  return cells;
}

function generateGrid(x, y) {
  var cells = [];

  for (var i = 0; i < x; i++) {
    cells[i] = [];
    for (var j = 0; j < y; j++) {
      cells[i][j] = [];
    }
  }

  return cells;
}

function randomCell(cells) {
  var max = cells.length;
  return cells[Math.floor(Math.random() * max)];
}

function flattern(arr) {
  arr = arr.slice();
  return arr.reduce(function (a, b) {
    return a.concat(b);
  });
}

function getCurrent(direction) {
  var axis = void 0;
  var axises = getVector(direction);

  for (var current in axises) {
    if ({}.hasOwnProperty.call(axises, current)) {
      if (axises[current] !== 0) {
        axis = current;
      }
    }
  }

  return {
    axis: axis,
    value: axises[axis]
  };
}

function getVector(direction) {
  var VECTORS = {};
  VECTORS.UP = { x: 1, y: 0 };
  VECTORS.LEFT = { x: 0, y: 1 };
  VECTORS.DOWN = { x: -1, y: 0 };
  VECTORS.RIGHT = { x: 0, y: -1 };
  return VECTORS[direction];
}

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvc2NyaXB0cy9hcHAuanMiLCJzcmMvc2NyaXB0cy9nYW1lLmpzIiwic3JjL3NjcmlwdHMvc3RvcmUuanMiLCJzcmMvc2NyaXB0cy91dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0FDQUE7Ozs7OztBQUVBLFNBQVMsZ0JBQVQsQ0FBMEIsa0JBQTFCLEVBQThDLFlBQVk7QUFDeEQsTUFBTSxPQUFPLG1CQUFTLENBQVQsQ0FBYjtBQUNELENBRkQ7Ozs7Ozs7OztBQ0ZBOzs7O0FBQ0E7Ozs7QUFFQSxJQUFNLE9BQU8sU0FBUyxJQUFULENBQWMsSUFBZCxFQUFvQjtBQUMvQixPQUFLLElBQUwsR0FBWSxJQUFaO0FBQ0EsT0FBSyxNQUFMLEdBQWMsU0FBUyxhQUFULENBQXVCLGlCQUF2QixDQUFkO0FBQ0EsT0FBSyxjQUFMLEdBQXNCLFNBQVMsYUFBVCxDQUF1QixpQkFBdkIsQ0FBdEI7QUFDQSxPQUFLLEtBQUwsR0FBYSxFQUFiO0FBQ0EsT0FBSyxLQUFMO0FBQ0QsQ0FORDs7QUFRQSxLQUFLLFNBQUwsQ0FBZSxLQUFmLEdBQXVCLFlBQVc7QUFDaEMsT0FBSyxLQUFMLEdBQWEscUJBQWI7QUFDQSxPQUFLLEtBQUwsQ0FBVyxTQUFYLENBQXFCLEtBQUssTUFBTCxDQUFZLElBQVosQ0FBaUIsSUFBakIsQ0FBckI7QUFDQSxPQUFLLEtBQUwsQ0FBVyxRQUFYLENBQW9CO0FBQ2xCLFVBQU0sTUFEWTtBQUVsQixVQUFNO0FBRlksR0FBcEI7QUFJQSxPQUFLLGNBQUw7QUFDRCxDQVJEOztBQVVBLEtBQUssU0FBTCxDQUFlLE1BQWYsR0FBd0IsVUFBUyxLQUFULEVBQWdCO0FBQ3RDLE9BQUssY0FBTCxDQUFvQixTQUFwQixHQUE4QixFQUE5QjtBQUNBLE1BQU0sT0FBTyxNQUFNLElBQW5CO0FBQ0EsTUFBTSxRQUFRLHFCQUFTLHFCQUFTLElBQVQsQ0FBVCxDQUFkO0FB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QUNBLFVBQVEsSUFBUixHQUFlLEVBQUMsR0FBRyxDQUFDLENBQUwsRUFBUSxHQUFHLENBQVgsRUFBZjtBQUNBLFVBQVEsS0FBUixHQUFnQixFQUFDLEdBQUcsQ0FBSixFQUFPLEdBQUcsQ0FBQyxDQUFYLEVBQWhCO0FBQ0EsU0FBTyxRQUFRLFNBQVIsQ0FBUDtBQUNEIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsImltcG9ydCBHYW1lIGZyb20gJy4vZ2FtZSc7XG5cbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJET01Db250ZW50TG9hZGVkXCIsIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgZ2FtZSA9IG5ldyBHYW1lKDQpO1xufSk7XG4iLCJpbXBvcnQgU3RvcmUgZnJvbSAnLi9zdG9yZSc7XG5pbXBvcnQgeyBmbGF0dGVybiB9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBHYW1lID0gZnVuY3Rpb24gR2FtZShzaXplKSB7XG4gIHRoaXMuc2l6ZSA9IHNpemU7XG4gIHRoaXMuJHRhYmxlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmdyaWQtY29udGFpbmVyJyk7XG4gIHRoaXMuJHRpbGVDb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGlsZS1jb250YWluZXInKTtcbiAgdGhpcy5xdWV1ZSA9IFtdO1xuICB0aGlzLnNldHVwKCk7XG59O1xuXG5HYW1lLnByb3RvdHlwZS5zZXR1cCA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLnN0b3JlID0gbmV3IFN0b3JlKCk7XG4gIHRoaXMuc3RvcmUuc3Vic2NyaWJlKHRoaXMucmVuZGVyLmJpbmQodGhpcykpO1xuICB0aGlzLnN0b3JlLmRpc3BhdGNoKHtcbiAgICB0eXBlOiAnSU5JVCcsXG4gICAgc2l6ZTogNFxuICB9KTtcbiAgdGhpcy5ldmVudExpc3RlbmVycygpO1xufTtcblxuR2FtZS5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oc3RhdGUpIHtcbiAgdGhpcy4kdGlsZUNvbnRhaW5lci5pbm5lckhUTUw9Jyc7XG4gIGNvbnN0IGdyaWQgPSBzdGF0ZS5ncmlkO1xuICBjb25zdCB0aWxlcyA9IGZsYXR0ZXJuKGZsYXR0ZXJuKGdyaWQpKTtcbiAgZm9yIChsZXQgaT0wOyBpIDwgdGlsZXMubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgJHRpbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAkdGlsZS5jbGFzc0xpc3QuYWRkKCd0aWxlJyk7XG4gICAgJHRpbGUuY2xhc3NMaXN0LmFkZChgdGlsZS0ke3RpbGVzW2ldLnZhbHVlfWApO1xuICAgICR0aWxlLmNsYXNzTGlzdC5hZGQoYHRpbGUtcG9zaXRpb24tJHt0aWxlc1tpXS54ICsgMX0tJHt0aWxlc1tpXS55ICsgMX1gKTtcbiAgICAkdGlsZS5pbm5lckhUTUwgPSB0aWxlc1tpXS52YWx1ZTtcbiAgICB0aGlzLiR0aWxlQ29udGFpbmVyLmFwcGVuZENoaWxkKCR0aWxlKTtcbiAgfVxufTtcblxuR2FtZS5wcm90b3R5cGUuZXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBtYXAgPSB7XG4gICAgMzg6ICdVUCcsXG4gICAgMzk6ICdSSUdIVCcsXG4gICAgNDA6ICdET1dOJyxcbiAgICAzNzogJ0xFRlQnXG4gIH07XG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIChldmVudCkgPT4ge1xuICAgIHZhciBtb2RpZmllcnMgPSBldmVudC5hbHRLZXkgfHwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnNoaWZ0S2V5O1xuICAgIHZhciBkaXJlY3Rpb24gICAgPSBtYXBbZXZlbnQud2hpY2hdO1xuXG4gICAgaWYgKCFtb2RpZmllcnMpIHtcbiAgICAgIGlmIChkaXJlY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLl9wcmVwYXJlKGRpcmVjdGlvbik7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn07XG5cbkdhbWUucHJvdG90eXBlLl9wcmVwYXJlID0gZnVuY3Rpb24oZGlyZWN0aW9uKSB7XG4gIHRoaXMuc3RvcmUuZGlzcGF0Y2goe1xuICAgIHR5cGU6ICdNT1ZFX1RJTEUnLFxuICAgIGRpcmVjdGlvblxuICB9KTtcbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaCh7XG4gICAgICB0eXBlOiAnQUNUVUFMSVpFJ1xuICAgIH0pO1xuICB9LCAxMDAwKTtcblxuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKHtcbiAgICAgIHR5cGU6ICdNRVJHRV9USUxFJ1xuICAgIH0pO1xuICB9LCAyMDApO1xufTtcblxuXG5cbmV4cG9ydCBkZWZhdWx0IEdhbWU7XG4iLCJpbXBvcnQgeyBnZW5lcmF0ZUNlbGxzLCBnZW5lcmF0ZUdyaWQsIHJhbmRvbUNlbGwsIGZsYXR0ZXJuLCBnZXRDdXJyZW50IH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IHN1YnNjcmliZXJzID0gW107XG5sZXQgaWQgPSAwO1xuY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICB3aW46IG51bGwsXG4gIHNjb3JlOiAwLFxuICBjZWxsczogZ2VuZXJhdGVDZWxscyg0LCA0KSxcbiAgZ3JpZDogZ2VuZXJhdGVHcmlkKDQsIDQpLFxuICBpc0FjdHVhbDogdHJ1ZVxufTtcblxuY29uc3QgU3RvcmUgPSBmdW5jdGlvbiBTdG9yZSgpIHtcbiAgdGhpcy5vbGRTdGF0ZSA9IHt9O1xuICB0aGlzLnN0YXRlID0gaW5pdGlhbFN0YXRlO1xufTtcblxuU3RvcmUucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uKGNiKSB7XG4gIHN1YnNjcmliZXJzLnB1c2goY2IpO1xufTtcblxuU3RvcmUucHJvdG90eXBlLnRyaWdnZXJTdWJzY3JpYmVycyA9IGZ1bmN0aW9uKCkge1xuICBzdWJzY3JpYmVycy5mb3JFYWNoKChzdWJzY3JpYmVyKSA9PiB7XG4gICAgc3Vic2NyaWJlcih0aGlzLnN0YXRlKTtcbiAgfSk7XG59O1xuXG5TdG9yZS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oYWN0aW9uLCBzdGF0ZSkge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgY2FzZSAnSU5JVCc6XG4gICAgICByZXR1cm4gdGhpcy5nZXRJbml0aWFsU3RhdGUoYWN0aW9uLnNpemUpO1xuICAgIGNhc2UgJ01PVkVfVElMRSc6XG4gICAgICByZXR1cm4gbW92ZUluRGlyZWN0aW9uKGFjdGlvbi5kaXJlY3Rpb24sIHN0YXRlKTtcbiAgICBjYXNlICdBQ1RVQUxJWkUnOlxuICAgICAgcmV0dXJuIGFjdHVhbGl6ZShzdGF0ZSk7XG4gICAgY2FzZSAnTUVSR0VfVElMRSc6XG4gICAgICByZXR1cm4gbWVyZ2VUaWxlcyhzdGF0ZSk7XG4gIH1cbiAgcmV0dXJuIHN0YXRlO1xufTtcblxuU3RvcmUucHJvdG90eXBlLmRpc3BhdGNoID0gZnVuY3Rpb24oYWN0aW9uKSB7XG4gIHRoaXMub2xkU3RhdGUgPSB0aGlzLnN0YXRlO1xuICB0aGlzLnN0YXRlID0gdGhpcy5yZWR1Y2UoYWN0aW9uLCB0aGlzLnN0YXRlKTtcbiAgdGhpcy50cmlnZ2VyU3Vic2NyaWJlcnMoKTtcbn07XG5cblN0b3JlLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gdGhpcy5zdGF0ZTtcbn07XG5cblN0b3JlLnByb3RvdHlwZS5nZXRJbml0aWFsU3RhdGUgPSBmdW5jdGlvbihzaXplKSB7XG4gIGxldCBzdGFydENvdW50ID0gMjtcbiAgbGV0IHN0YXRlID0gdGhpcy5zdGF0ZTtcbiAgbGV0IGNlbGw7XG4gIHdoaWxlIChzdGFydENvdW50ID4gMCkge1xuICAgIGNlbGwgPSByYW5kb21DZWxsKHN0YXRlLmNlbGxzKTtcbiAgICBjb25zb2xlLmxvZyhjZWxsKTtcbiAgICBzdGF0ZSA9IG5ld1RpbGUoc3RhdGUsIGNlbGwpO1xuICAgIHN0YXJ0Q291bnQtLTtcbiAgfVxuICByZXR1cm4gc3RhdGU7XG59O1xuXG5mdW5jdGlvbiBuZXdUaWxlKHN0YXRlLCBjZWxsKSB7XG4gIHN0YXRlID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUpO1xuICBpZiAoIXN0YXRlLmNlbGxzLmxlbmd0aCkgcmV0dXJuIHN0YXRlO1xuXG4gIGNvbnN0IHggPSBmbGF0dGVybihmbGF0dGVybihzdGF0ZS5ncmlkKSkuZmluZCgodCkgPT4ge1xuICAgIHJldHVybiB0LnZhbHVlID09PSAneCc7XG4gIH0pO1xuXG4gIGlmIChpZCA+IDEgJiYgIXgpIHN0YXRlID0gYWRkVGlsZShzdGF0ZSwgY2VsbCwgXCJ4XCIpO1xuICBlbHNlIHN0YXRlID0gYWRkVGlsZShzdGF0ZSwgY2VsbCk7XG4gIHN0YXRlLmNlbGxzID0gc3RhdGUuY2VsbHMuZmlsdGVyKChvYmopID0+IHtcbiAgICByZXR1cm4gIShvYmoueCA9PT0gY2VsbC54ICYmIG9iai55ID09PSBjZWxsLnkpO1xuICB9KTtcbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBhZGRUaWxlKHN0YXRlLCB0aWxlLCB2YWx1ZSkge1xuICBzdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXRlKTtcbiAgdGlsZSA9IE9iamVjdC5hc3NpZ24oe30sIHRpbGUpO1xuICB0aWxlLmlkID0gaWQrKztcbiAgdGlsZS52YWx1ZSA9IHZhbHVlIHx8IDI7XG4gIHN0YXRlLmdyaWRbdGlsZS54XVt0aWxlLnldLnB1c2godGlsZSk7XG4gIHJldHVybiBzdGF0ZTtcbn1cblxuZnVuY3Rpb24gbW92ZUluRGlyZWN0aW9uKGRpcmVjdGlvbiwgc3RhdGUpIHtcbiAgc3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSk7XG4gIGxldCBpbml0aWFsID0gc3RhdGU7XG4gIGxldCBkaXJlY3Rpb25zID0gWydVUCcsICdSSUdIVCcsICdET1dOJywgJ0xFRlQnXTtcbiAgbGV0IHRpbGVzID0gZmxhdHRlcm4oZmxhdHRlcm4oc3RhdGUuZ3JpZCkpO1xuXG4gIGNvbnN0IGNoZWNrID0gKGN1cnJlbnQpID0+IHtcbiAgICBpZiAoY3VycmVudCAhPT0gZGlyZWN0aW9uKSBpbml0aWFsID0gc3RhdGU7XG5cbiAgICBkaXJlY3Rpb25zID0gZGlyZWN0aW9ucy5maWx0ZXIoZGlyID0+IGRpciAhPT0gY3VycmVudCk7XG4gICAgdGlsZXMgPSBzb3J0VGlsZXModGlsZXMsIGN1cnJlbnQpO1xuICAgIHN0YXRlID0gbW92ZVRpbGVzKHN0YXRlLCB0aWxlcywgY3VycmVudCk7XG5cbiAgICBpZiAoaW5pdGlhbCA9PT0gc3RhdGUpIHtcbiAgICAgIGlmIChkaXJlY3Rpb25zLmxlbmd0aCkgcmV0dXJuIGNoZWNrKGRpcmVjdGlvbnNbMF0pO1xuICAgICAgcmV0dXJuIHN0YXRlLndpbiA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiAoY3VycmVudCAhPT0gZGlyZWN0aW9uKSA/IGluaXRpYWwgOiBzdGF0ZTtcbiAgfTtcblxuICByZXR1cm4gY2hlY2soZGlyZWN0aW9uKTtcbn1cblxuZnVuY3Rpb24gc29ydFRpbGVzKHRpbGVzLCBkaXJlY3Rpb24pIHtcbiAgY29uc3Qge2F4aXMsIHZhbHVlfSA9IGdldEN1cnJlbnQoZGlyZWN0aW9uKTtcbiAgdGlsZXMgPSB0aWxlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgcmV0dXJuIGFbYXhpc10gLSBiW2F4aXNdO1xuICB9KTtcbiAgaWYgKHZhbHVlIDwgMCkgdGlsZXMgPSB0aWxlcy5yZXZlcnNlKCk7XG4gIHJldHVybiB0aWxlcztcbn1cblxuZnVuY3Rpb24gbW92ZVRpbGVzKHN0YXRlLCB0aWxlcywgZGlyZWN0aW9uKSB7XG4gIHRpbGVzLmZvckVhY2godGlsZSA9PiBzdGF0ZSA9IG1vdmVUaWxlKHN0YXRlLCB0aWxlLCBkaXJlY3Rpb24pKTtcbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBtb3ZlVGlsZShzdGF0ZSwgdGlsZSwgZGlyZWN0aW9uKSB7XG4gIHN0YXRlID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUpO1xuICBjb25zdCBhdmFpbGFibGUgPSBmaW5kQXZhaWxhYmxlQ2VsbChzdGF0ZSwgdGlsZSwgZGlyZWN0aW9uKTtcbiAgaWYgKGF2YWlsYWJsZSkge1xuICAgIHN0YXRlLmlzQWN0dWFsID0gZmFsc2U7XG4gICAgc3RhdGUuZ3JpZFthdmFpbGFibGUuaW5kZXhdW2F2YWlsYWJsZS52YWx1ZV0ucHVzaCh0aWxlKTtcbiAgICBzdGF0ZS5ncmlkW3RpbGUueF1bdGlsZS55XS5wb3AoKTtcbiAgfVxuXG4gIHJldHVybiBzdGF0ZTtcbn1cblxuZnVuY3Rpb24gZmluZEF2YWlsYWJsZUNlbGwoc3RhdGUsIHRpbGUsIGRpcmVjdGlvbikge1xuICBsZXQgYXZhaWxhYmxlO1xuICBjb25zdCB7YXhpcywgdmFsdWV9ID0gZ2V0Q3VycmVudChkaXJlY3Rpb24pO1xuICBsZXQgZnJvbSA9IHRpbGVbYXhpc107XG4gIGxldCB0byA9IHZhbHVlIDwgMCA/ICg0IC0gMSkgOiAwO1xuICBjb25zdCBhcnIgPSBbXTtcblxuICBpZiAoZnJvbSA8PSB0bykge1xuICAgIHdoaWxlKGZyb20gPD0gdG8pIHtcbiAgICAgIGFyci5wdXNoKGZyb20rKyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHdoaWxlKHRvID49IGZyb20pIHtcbiAgICAgIGFyci5wdXNoKHRvLS0pO1xuICAgIH1cbiAgfVxuXG4gIGFyci5mb3JFYWNoKChpbmRleCkgPT4ge1xuICAgIGxldCBwYXRoO1xuICAgIGlmIChheGlzID09PSAneCcpIHtcbiAgICAgIHBhdGggPSB7XG4gICAgICAgIGluZGV4OiBpbmRleCxcbiAgICAgICAgdmFsdWU6IHRpbGUueVxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0aCA9IHtcbiAgICAgICAgaW5kZXg6IHRpbGUueCxcbiAgICAgICAgdmFsdWU6IGluZGV4XG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IGNlbGwgPSBzdGF0ZS5ncmlkW3BhdGguaW5kZXhdW3BhdGgudmFsdWVdO1xuXG4gICAgaWYgKCFpc1N1aXRhYmxlKGNlbGwsIHRpbGUpKSB7XG4gICAgICBhdmFpbGFibGUgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aWxlLnZhbHVlID09PSBcInhcIikge1xuICAgICAgaWYgKGNlbGwubGVuZ3RoID09PSAxIHx8ICghY2VsbC5sZW5ndGggJiYgIWF2YWlsYWJsZSkpIGF2YWlsYWJsZSA9IHBhdGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF2YWlsYWJsZSA9IGF2YWlsYWJsZSB8fCBwYXRoO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGF2YWlsYWJsZTtcbn1cblxuZnVuY3Rpb24gaXNTdWl0YWJsZShjZWxsLCB0aWxlKSB7XG4gIGNvbnN0IHQxID0gY2VsbFswXSA/IGNlbGxbMF0udmFsdWUgOiAnJztcbiAgY29uc3QgdDIgPSB0aWxlLnZhbHVlO1xuXG4gIGlmIChjZWxsLmxlbmd0aCA+IDEpIHJldHVybiBmYWxzZTtcbiAgaWYgKGNlbGwubGVuZ3RoKSB7XG4gICAgaWYgKHQxID09PSAneCcgfHwgdDIgPT09ICd4JykgcmV0dXJuIHRydWU7XG4gICAgaWYgKHQxICE9PSB0MikgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIGFjdHVhbGl6ZShzdGF0ZSkge1xuICBzdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXRlKTtcbiAgbGV0IGdyaWQgPSBzdGF0ZS5ncmlkO1xuXG4gIGdyaWQuZm9yRWFjaCgocm93LCB4KSA9PiB7XG4gICAgcm93LmZvckVhY2goKGNlbGwsIHkpID0+IHtcbiAgICAgIGlmICghY2VsbC5sZW5ndGgpIHJldHVybjtcbiAgICAgIGNlbGwuZm9yRWFjaCgodGlsZSwgaW5kZXgpID0+IHtcbiAgICAgICAgaWYgKHRpbGUueCAhPT0geCB8fCB0aWxlLnkgIT09IHkpIHtcbiAgICAgICAgICBncmlkW3hdW3ldW2luZGV4XS54ID0geDtcbiAgICAgICAgICBncmlkW3hdW3ldW2luZGV4XS55ID0geTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuICBzdGF0ZS5pc0FjdHVhbCA9IHRydWU7XG4gIHN0YXRlLmdyaWQgPSBncmlkO1xuICByZXR1cm4gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIG1lcmdlVGlsZXMoc3RhdGUpIHtcbiAgc3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSk7XG4gIGxldCBjZWxscyA9IFtdO1xuICBsZXQgZ3JpZCA9IHN0YXRlLmdyaWQ7XG4gIGxldCByZXN1bHQgPSAwO1xuXG4gIGdyaWQuZm9yRWFjaCgocm93LCB4KSA9PiB7XG4gICAgcm93LmZvckVhY2goKGNlbGwsIHkpID0+IHtcbiAgICAgIGlmICghY2VsbC5sZW5ndGgpIHtcbiAgICAgICAgY2VsbHMucHVzaCh7eCwgeX0pO1xuICAgICAgfVxuICAgICAgaWYgKGNlbGwubGVuZ3RoID4gMSkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGNlbGwucmVkdWNlKCh0MSwgdDIpID0+IGNhbGN1bGF0ZVRpbGVzKHQxLCB0MikpO1xuXG4gICAgICAgIHJlc3VsdCArPSB2YWx1ZTtcbiAgICAgICAgLy8gZ3JpZCA9IGdyaWQudXBkYXRlSW4oW3gsIHldLCAoKSA9PiBMaXN0Lm9mKGNlbGwuZmlyc3QoKS5tZXJnZSh7dmFsdWUsIGlkOiBpZCsrfSkpKTtcbiAgICAgICAgc3RhdGUud2luID0gKHZhbHVlID09PSAnMjA0OCcgfHwgbnVsbCk7XG4gICAgICAgIHN0YXRlLnNjb3JlICs9IHZhbHVlO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBzdGF0ZS5jZWxscyA9IGNlbGxzO1xuICBzdGF0ZS5yZXN1bHQgPSByZXN1bHQ7XG4gIHN0YXRlLmdyaWQgPSBncmlkO1xuXG4gIHJldHVybiBzdGF0ZTtcblxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVUaWxlcyh0MSwgdDIpIHtcbiAgaWYgKHQxLnZhbHVlID09PSBcInhcIikgcmV0dXJuIHQyLnZhbHVlICogMjtcbiAgaWYgKHQyLnZhbHVlID09PSBcInhcIikgcmV0dXJuIHQxLnZhbHVlICogMjtcbiAgcmV0dXJuIHQxLnZhbHVlICsgdDIudmFsdWU7XG59XG5cblxuXG5leHBvcnQgZGVmYXVsdCBTdG9yZTtcbiIsImV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUNlbGxzKHgsIHkpIHtcbiAgbGV0IGNlbGxzID0gW107XG5cbiAgZm9yIChsZXQgaT0wOyBpPHg7IGkrKykge1xuICAgIGZvciAobGV0IGo9MDsgajx5OyBqKyspIHtcbiAgICAgIGNlbGxzLnB1c2goe1xuICAgICAgICB4OiBpLFxuICAgICAgICB5OiBqXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gY2VsbHM7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlR3JpZCh4LCB5KSB7XG4gIGxldCBjZWxscyA9IFtdO1xuXG4gIGZvciAobGV0IGk9MDsgaTx4OyBpKyspIHtcbiAgICBjZWxsc1tpXSA9IFtdO1xuICAgIGZvciAobGV0IGo9MDsgajx5OyBqKyspIHtcbiAgICAgIGNlbGxzW2ldW2pdID0gW107XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGNlbGxzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmFuZG9tQ2VsbChjZWxscykge1xuICBjb25zdCBtYXggPSBjZWxscy5sZW5ndGg7XG4gIHJldHVybiBjZWxsc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXgpXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZXJuKGFycikge1xuICBhcnIgPSBhcnIuc2xpY2UoKTtcbiAgcmV0dXJuIGFyci5yZWR1Y2UoKGEsIGIpID0+IHtcbiAgICByZXR1cm4gYS5jb25jYXQoYik7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VycmVudChkaXJlY3Rpb24pIHtcbiAgbGV0IGF4aXM7XG4gIGNvbnN0IGF4aXNlcyA9IGdldFZlY3RvcihkaXJlY3Rpb24pO1xuXG4gIGZvciAoY29uc3QgY3VycmVudCBpbiBheGlzZXMpIHtcbiAgICBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChheGlzZXMsIGN1cnJlbnQpKSB7XG4gICAgICBpZiAoYXhpc2VzW2N1cnJlbnRdICE9PSAwKSB7XG4gICAgICAgIGF4aXMgPSBjdXJyZW50O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgYXhpcyxcbiAgICB2YWx1ZTogYXhpc2VzW2F4aXNdXG4gIH07XG59XG5cbmZ1bmN0aW9uIGdldFZlY3RvcihkaXJlY3Rpb24pIHtcbiAgY29uc3QgVkVDVE9SUyA9IHt9O1xuICBWRUNUT1JTLlVQID0ge3g6IDEsIHk6IDB9O1xuICBWRUNUT1JTLkxFRlQgPSB7eDogMCwgeTogMX07XG4gIFZFQ1RPUlMuRE9XTiA9IHt4OiAtMSwgeTogMH07XG4gIFZFQ1RPUlMuUklHSFQgPSB7eDogMCwgeTogLTF9O1xuICByZXR1cm4gVkVDVE9SU1tkaXJlY3Rpb25dO1xufVxuIl19
